<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
	<style>
		div {
			position: relative;
			width: 817px;
		}

		#checkbox {
			position: absolute;
			bottom: 6px;
			right: 4px;
		}
	</style>
</head>
<body>
<div>
	<canvas id="coveringCanvas"></canvas>
	<input type="checkbox" id="checkbox"/>
</div>

<script>
	let d = new Date();
	let canvas = document.getElementById('coveringCanvas');
	let checkbox = document.getElementById('checkbox');
	let context = canvas.getContext('2d');
	let imWidth = 817;
	let imHeight = 240;
	let imStartX = 317;
	let imStartY = 126;
	let image = new Image();

	image.onload = function (e) {
		canvas.width = imWidth;
		canvas.height = imHeight;
		setCurrentPoint()
	};
	image.src = `/image.jpg`;

	canvas.onclick = function (e) {
		 let offsets = canvas.getClientRects()[0];
		 let y = e.pageY - offsets.top;
		 let x = e.pageX - offsets.left;
		console.log(`${x},${y}`);
		ws.sendToServer({x, y, set: checkbox.checked});
	};

	function setPoint(xy) {
		context.beginPath();
		context.arc(xy.x, xy.y, 32, 0, 2 * Math.PI, false);
		context.lineWidth = 10;
		context.strokeStyle = '#ff0100';
		context.stroke();
	}

	function clearImage() {
		context.drawImage(image,
				imStartX, imStartY, imWidth, imHeight,
				0, 0, imWidth, imHeight);
	}

	 checkbox.onclick = function (e) {
		 if (checkbox.checked) {
			 clearImage();
			 let xobj = new XMLHttpRequest();
			 xobj.open('GET', '/config.json', true); // Replace 'my_data' with the path to your file
			 xobj.onload = function () {
				 let d = JSON.parse(xobj.responseText);
				 d.forEach(setPoint);
			 };
			 xobj.send(null);
		 } else {
		 	setCurrentPoint();
		 }
	 };

	 function setCurrentPoint() {
			clearImage();
			setPoint(window.currentPoint)
	 }

	 function WsHandler() {
		var self = this;
		self.wsState = 0; // 0 - not inited, 1 - tried to connect but failed; 9 - connected;

		self.wsConnectionId = '';
		self.onWsMessage = function (message) {
				let xy = JSON.parse(message.data);
				if (xy.length) {
					clearImage();
					xy.forEach(setPoint)
				} else {
					window.currentPoint = xy;
					setCurrentPoint();
				}
		};
		self.sendToServer = function (messageRequest) {
			var jsonRequest = JSON.stringify(messageRequest);
			if (self.ws.readyState == WebSocket.OPEN) {
				self.ws.send(jsonRequest);
			}
		};

		self.setStatus = function (isOnline) {
			console.log('asd')
		};
		self.onWsClose = function (e) {
			self.setStatus(false);
			var reason = e.reason || e;
			self.wsState = 1;
			// Try to reconnect in 10 seconds
			setTimeout(self.listenWS, 1000);
		};
		self.listenWS = function () {
			if (!window.WebSocket) {
				return;
			}
			self.ws = new WebSocket('ws://' + window.location.host + '/ws');
			self.ws.onmessage = self.onWsMessage;
			self.ws.onclose = self.onWsClose;
			self.ws.onopen = function () {
				self.setStatus(true);
			};
		};
	}

	var ws = new WsHandler();
	ws.listenWS();

</script>
</body>
</html>