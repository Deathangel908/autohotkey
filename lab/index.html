<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
</head>
<body>
<canvas id="coveringCanvas"></canvas>
<script>
  let map = [{x: 27, y: 120}, {x: 95, y: 120}, {x: 163, y: 120}, {x: 235, y: 120}, {x: 306, y: 120}, {x: 342, y: 32}, {x: 510, y: 120}, {x: 582, y: 120}, {x: 646, y: 120}, {x: 783, y: 120}];
  let d = new Date();
  let canvas = document.getElementById('coveringCanvas');
  let context = canvas.getContext('2d');
  let imWidth = 817;
  let imHeight = 240;
  let imStartX = 317;
  let imStartY = 126;
  let image = new Image();

  image.onload = function (e) {
    canvas.width = imWidth;
    canvas.height = imHeight;
    context.drawImage(image,
        imStartX, imStartY, imWidth, imHeight,
        0, 0, imWidth, imHeight);
  };
  image.src = `/${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}_uber.jpg`;


  canvas.onclick = function (e) {
    let y = e.pageY - canvas.offsetTop;
    let x = e.pageX - canvas.offsetLeft;
    map.forEach((m, i) => {
      if (((m.x - x) * (m.x - x) + (m.y - y) * (m.y - y)) < 500) {
        ws.sendToServer(i);
      }
    })
  };

  function setStep(xy) {
    context.drawImage(image,
        imStartX, imStartY, imWidth, imHeight,
        0, 0, imWidth, imHeight);
    context.beginPath();
    context.arc(xy.x, xy.y, 32, 0, 2 * Math.PI, false);
    context.lineWidth = 10;
    context.strokeStyle = '#ff0100';
    context.stroke();
  }


  function WsHandler() {
    var self = this;
    self.wsState = 0; // 0 - not inited, 1 - tried to connect but failed; 9 - connected;

    self.wsConnectionId = '';
    self.onWsMessage = function (message) {
      setStep(map[message.data]);
    };
    self.sendToServer = function (messageRequest) {
      var jsonRequest = JSON.stringify(messageRequest);
      if (self.ws.readyState == WebSocket.OPEN) {
        self.ws.send(jsonRequest);
      }
    };

    self.setStatus = function (isOnline) {
      console.log('asd')
    };
    self.onWsClose = function (e) {
      self.setStatus(false);
      var reason = e.reason || e;
      self.wsState = 1;
      // Try to reconnect in 10 seconds
      setTimeout(self.listenWS, 1000);
    };
    self.listenWS = function () {
      if (!window.WebSocket) {
        return;
      }
      self.ws = new WebSocket('ws://'+window.location.host + '/ws');
      self.ws.onmessage = self.onWsMessage;
      self.ws.onclose = self.onWsClose;
      self.ws.onopen = function () {
        self.setStatus(true);
      };
    };
  }

  var ws = new WsHandler();
	ws.listenWS();

</script>
</body>
</html>